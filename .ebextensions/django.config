packages:
    yum:
        git: []

files:
    "/opt/elasticbeanstalk/hooks/appdeploy/post/99_node.sh":
        mode: "000755"
        owner: root
        group: root
        content: |
            #!/bin/bash

            cd /var/app/current

            curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.5/install.sh | bash

            # Source nvm
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
            [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion

            # Install node
            nvm install 8.6.0
            cd frontend && npm install && npm run build

option_settings:
    "aws:elasticbeanstalk:application:environment":
        # your settings module here
        DJANGO_SETTINGS_MODULE: "backend.settings" 
        
        # add the path to the root of the django app
        PYTHONPATH: "/opt/python/current/app/backend:$PYTHONPATH"
        
    "aws:elasticbeanstalk:container:python":
        # path to the wsgi.py file from the root folder of the application
        WSGIPath: backend/backend/wsgi.py
        NumProcesses: 3 
        NumThreads: 20
        
    "aws:elasticbeanstalk:container:python:staticfiles":
        "/static/": "static/"

# These commands run just before the deployment finishes
container_commands:
    01_migrate:
        command: 'python backend/manage.py migrate --noinput'
        leader_only: true

    02_createadmin:
        command: python backend/manage.py createsuperuser
        leader_only: true
        
    04_collectstatic:
        command: 'python backend/manage.py collectstatic'